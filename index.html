<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amalan Ramadhan Siswa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Konfigurasi default aplikasi
    const DEFAULT_CONFIG = {
        app_title: "Amalan Ramadhan Siswa",
        bank_name: "BANK RAKYAT INDONESIA (BRI)",
        bank_account: "1234567890 a/n AdminKU",
        registration_fee: "Rp. 100.000",
        master_password: "admin"
    };

    // URL Backend (Google Apps Script)
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7IjJZdiHITMGhSMSWWneT1E9qIWUOBwkuJv4krc4_IPk-pQYA1hgFXyNfMu9oKjr6Bw/exec';

    const loadLocalConfig = () => {
        const saved = localStorage.getItem('master_config');
        return saved ? JSON.parse(saved) : DEFAULT_CONFIG;
    };

    window.elementSdk = {
        config: loadLocalConfig(),
        setConfig: (conf) => { 
            const updated = { ...window.elementSdk.config, ...conf };
            window.elementSdk.config = updated;
            localStorage.setItem('master_config', JSON.stringify(updated));
        }
    };
  </script>
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; box-sizing: border-box; }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .tab-button.active { background: #10b981; color: white; border-bottom: 4px solid #059669; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .admin-tab.active { border-bottom: 4px solid #10b981; color: #10b981; }
        
        @keyframes pulse-custom {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            50% { transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4); }
        }
        .animate-pulse-custom { animation: pulse-custom 2s infinite; }
        .loader { border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #ffffff; border-radius: 50%; width: 18px; height: 18px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        button:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
    </style>
 </head>
 <body class="h-full bg-slate-50 text-slate-800 text-center">
  <div id="app" class="w-full h-full overflow-auto text-center"></div>
  <script>
        // --- CORE FUNCTIONS ---
        function getSchoolId() {
            const params = new URLSearchParams(window.location.search);
            let id = params.get('id');
            if (!id && window.location.href.includes('id=')) { id = window.location.href.split('id=')[1].split('&')[0]; }
            return id || sessionStorage.getItem('current_school_id');
        }

        function showSkeleton() {
            const app = document.getElementById('app');
            if (!app) return;
            app.innerHTML = `
                <div class="min-h-screen bg-emerald-600 flex flex-col items-center justify-center p-6 text-center text-white">
                    <div class="w-full max-w-md bg-white/20 p-10 rounded-[2.5rem] shadow-2xl animate-pulse backdrop-blur-sm border border-white/10">
                        <div class="flex flex-col items-center space-y-8">
                            <div class="h-10 w-48 bg-white/30 rounded-xl"></div>
                            <div class="w-full space-y-4">
                                <div class="h-14 w-full bg-white/30 rounded-2xl"></div>
                                <div class="h-14 w-full bg-white/30 rounded-2xl"></div>
                            </div>
                            <div class="h-16 w-full bg-white/40 rounded-2xl mt-4"></div>
                        </div>
                    </div>
                </div>`;
        }

        function showToast(message, isSuccess = true) {
            const toast = document.createElement('div');
            toast.className = `toast fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl text-white z-[600] font-bold ${isSuccess ? 'bg-emerald-600' : 'bg-rose-600'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function formatRupiah(val) {
            if (!val) return "Rp. 0";
            let str = val.toString().trim();
            if (str.includes("Rp")) return str;
            let num = str.replace(/[^0-9]/g, '');
            if (num === '') return str;
            return "Rp. " + parseInt(num).toLocaleString('id-ID');
        }

        // --- STATE ---
        let SCHOOL_ID = getSchoolId();
        let schoolName = "Akses Aplikasi Siswa"; 
        let currentUser = null;
        let currentTab = 'Shalat Fardu';
        let currentAdminTab = 'config'; 
        let allRecords = []; 
        let cloudRecords = []; 
        const categories = ['Shalat Fardu', 'Tarawih', 'Puasa', 'Tadarus', 'Ceramah'];

        let shalatData = {};
        let tarawihData = {};
        let puasaData = {};
        let tadarusData = {};
        let ceramahData = {};

        function initDefaultData() {
            for (let i = 1; i <= 30; i++) {
                shalatData[i] = { 'Subuh': null, 'Dzuhur': null, 'Ashar': null, 'Maghrib': null, 'Isya': null };
                tarawihData[i] = { status: null, tempat: null };
                puasaData[i] = null;
                tadarusData[i] = { pilihan: null, surat: '', ayat: '' };
                ceramahData[i] = { penceramah: '', tempat: '', ringkasan: '' };
            }
        }
        initDefaultData();

        // --- DATA HELPERS ---
        function getMergedRecords(records) {
            const map = new Map();
            if(!Array.isArray(records)) return [];
            records.forEach(r => {
                const key = `${r.nama}-${r.kelas}-${r.kategori}-${r.tanggal}`;
                map.set(key, r); 
            });
            return Array.from(map.values());
        }

        function parseRecordData(d) {
            if (!d) return null;
            if (typeof d === 'object') return d;
            try { 
                const str = d.toString().trim();
                if (str.startsWith('{') || str.startsWith('[')) { return JSON.parse(str); }
                return d;
            } catch (e) { return d; }
        }

        function renderDetailText(k, d) { 
            if (!d) return '-';
            let data = parseRecordData(d);
            if (k === 'Shalat Fardu') {
                if (typeof data === 'object' && data !== null && !Array.isArray(data)) {
                    const ordered = ['Subuh', 'Dzuhur', 'Ashar', 'Maghrib', 'Isya'];
                    return ordered.filter(key => data[key]).map(key => `${key}: <b>${data[key]}</b>`).join(' | ') || 'Kosong';
                }
                return `Status: <b>${data}</b>`;
            }
            if (k === 'Tarawih' && typeof data === 'object' && data !== null) return `Status: <b>${data.status || '-'}</b>, Lokasi: <b>${data.tempat || '-'}</b>`;
            if (k === 'Puasa') return `Status: <b>${typeof data === 'string' ? data : (data.status || '-')}</b>`;
            if (k === 'Tadarus' && typeof data === 'object' && data !== null) return `Metode: <b>${data.pilihan || '-'}</b>, Surat: <b>${data.surat || '-'}</b> (Ayat ${data.ayat || '-'})`;
            if (k === 'Ceramah' && typeof data === 'object' && data !== null) return `Penceramah: <b>${data.penceramah || '-'}</b>, Lokasi: <b>${data.tempat || '-'}</b>`;
            return typeof data === 'string' ? data : JSON.stringify(data);
        }

        function getCategoryIcon(k) { switch(k) { case 'Shalat Fardu': return 'üïå'; case 'Tarawih': return 'üåô'; case 'Puasa': return 'üçΩÔ∏è'; case 'Tadarus': return 'üìñ'; case 'Ceramah': return 'üéôÔ∏è'; default: return 'üìù'; } }

        // --- MASTER PROVIDER PAGES ---
        async function fetchGlobalSettings() {
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getGlobalSettings`);
                const data = await res.json();
                if (data.status === 'success') { window.elementSdk.setConfig(data.config); return data.config; }
            } catch (e) { console.warn("Sync failed."); }
            return window.elementSdk.config;
        }

        async function fetchCurrentSchoolName() {
            if (!SCHOOL_ID) return;
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getTeachersList`);
                const data = await res.json();
                if (data.status === 'success' && Array.isArray(data.teachers)) {
                    const schoolData = data.teachers.find(t => t.ss_id === SCHOOL_ID);
                    if (schoolData) {
                        schoolName = schoolData.school;
                    }
                }
            } catch (e) { console.warn("Gagal memuat nama sekolah."); }
        }

        async function updatePendingBadges() {
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getTeachersList`);
                const data = await res.json();
                if (data.status === 'success') {
                    const count = data.teachers.filter(t => (t.status || '').trim() === 'Menunggu').length;
                    const b1 = document.getElementById('badgePending');
                    if (b1) { if(count > 0) { b1.textContent = count; b1.classList.remove('hidden'); } else b1.classList.add('hidden'); }
                    const b2 = document.getElementById('landingAdminBadge');
                    if (b2) { if(count > 0) { b2.textContent = count; b2.classList.remove('hidden'); } else b2.classList.add('hidden'); }
                }
            } catch (e) {}
        }

        window.switchAdminTab = (tab) => {
            currentAdminTab = tab;
            renderMasterAdmin();
        };

        function renderMasterAdmin() {
            const config = window.elementSdk.config;
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-slate-900 p-4 md:p-8 text-white">
                    <div class="max-w-4xl mx-auto text-center">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h1 class="text-3xl font-black text-emerald-400 tracking-tighter uppercase">Master Control Panel</h1>
                            <button onclick="location.reload()" class="px-6 py-2 bg-slate-800 rounded-xl text-xs font-bold border border-slate-700 hover:bg-slate-700 transition-all uppercase">KELUAR</button>
                        </div>
                        <div class="flex gap-8 mb-8 border-b border-slate-800 overflow-x-auto no-scrollbar relative text-center">
                            <button onclick="switchAdminTab('config')" class="admin-tab py-4 font-black text-sm uppercase tracking-widest transition-all whitespace-nowrap ${currentAdminTab === 'config' ? 'active' : 'text-slate-500 hover:text-white'}">Konfigurasi</button>
                            <button onclick="switchAdminTab('orders')" class="admin-tab py-4 font-black text-sm uppercase tracking-widest transition-all whitespace-nowrap relative ${currentAdminTab === 'orders' ? 'active' : 'text-slate-500 hover:text-white'}">
                                Daftar Pesanan
                                <span id="badgePending" class="hidden absolute -top-1 -right-4 bg-rose-600 text-white text-[9px] font-black w-5 h-5 rounded-full flex items-center justify-center border-2 border-slate-900 shadow-lg text-center">0</span>
                            </button>
                        </div>
                        <div id="adminContentArea"></div>
                    </div>
                </div>`;
            renderAdminContent();
            updatePendingBadges();
        }

        function renderAdminContent() {
            const area = document.getElementById('adminContentArea');
            if (!area) return;
            if (currentAdminTab === 'config') {
                const config = window.elementSdk.config;
                area.innerHTML = `
                    <div class="bg-slate-800 p-8 rounded-[2.5rem] shadow-xl space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 text-left">
                        <div class="grid gap-5 text-slate-800">
                            <div><label class="block text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest text-left">Nama Aplikasi</label><input id="m_title" type="text" value="${config.app_title}" class="w-full p-4 bg-slate-100 rounded-xl font-bold border-2 border-transparent focus:border-emerald-500 outline-none transition-all text-slate-800"></div>
                            <div><label class="block text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest text-left">Nama Bank</label><input id="m_bank" type="text" value="${config.bank_name}" class="w-full p-4 bg-slate-100 rounded-xl font-bold border-2 border-transparent focus:border-emerald-500 outline-none transition-all text-slate-800"></div>
                            <div><label class="block text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest text-left">Nomor Rekening & Nama</label><input id="m_rek" type="text" value="${config.bank_account}" class="w-full p-4 bg-slate-100 rounded-xl font-bold border-2 border-transparent focus:border-emerald-500 outline-none transition-all text-slate-800"></div>
                            <div><label class="block text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest text-left">Biaya Aktivasi</label><input id="m_fee" type="text" value="${config.registration_fee}" class="w-full p-4 bg-slate-100 rounded-xl font-bold border-2 border-transparent focus:border-emerald-500 outline-none transition-all text-slate-800"></div>
                            <div><label class="block text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest text-left">Password Master</label><input id="m_pass" type="text" value="${config.master_password}" class="w-full p-4 bg-slate-100 rounded-xl font-bold border-2 border-transparent focus:border-emerald-500 outline-none transition-all text-slate-800"></div>
                        </div>
                        <button id="saveGlobalBtn" onclick="saveMasterSettings()" class="w-full py-5 bg-emerald-600 rounded-[1.5rem] font-black shadow-lg hover:bg-emerald-500 transition-all text-center uppercase tracking-widest">SIMPAN PERUBAHAN GLOBAL</button>
                    </div>`;
            } else {
                area.innerHTML = `
                    <div class="bg-slate-800 p-4 md:p-8 rounded-[2.5rem] shadow-xl animate-in fade-in slide-in-from-bottom-4 duration-500 text-left">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-black text-emerald-400 uppercase tracking-widest text-left text-white">Sekolah Terdaftar</h2>
                            <button onclick="fetchTeachersList()" class="p-2 bg-slate-700 rounded-lg hover:bg-slate-600 text-xs font-bold transition-all text-center">üîÑ Segarkan</button>
                        </div>
                        <div class="overflow-x-auto no-scrollbar">
                            <table class="w-full text-left border-collapse min-w-[700px] text-center text-white">
                                <thead><tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-700"><th class="p-4 text-center">Tgl Daftar</th><th class="p-4 text-left">Nama Sekolah</th><th class="p-4 text-left">Email Admin</th><th class="p-4 text-center">Bukti TF</th><th class="p-4 text-center">Status</th></tr></thead>
                                <tbody id="teachersListBody"><tr><td colspan="5" class="p-10 text-center italic text-slate-500">Memuat data...</td></tr></tbody>
                            </table>
                        </div>
                    </div>`;
                fetchTeachersList();
            }
        }

        async function fetchTeachersList() {
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getTeachersList`);
                const data = await res.json();
                const body = document.getElementById('teachersListBody');
                if (!body) return;
                const sorted = data.teachers.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (data.status === 'success' && sorted.length > 0) {
                    body.innerHTML = sorted.map((t) => {
                        const statusClean = (t.status || 'Menunggu').trim();
                        return `<tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition-all text-center"><td class="p-4 text-[10px] font-bold text-slate-400 text-center">${new Date(t.date).toLocaleDateString('id-ID')}</td><td class="p-4 font-black text-white uppercase tracking-tight text-sm text-left">${t.school}</td><td class="p-4 text-xs font-bold text-emerald-400 text-left">${t.email}</td><td class="p-4 text-center">${t.proof ? `<img src="${t.proof}" onclick="viewProof('${t.proof}', '${t.school}')" class="w-16 h-10 object-cover rounded-lg border-2 border-slate-600 cursor-pointer hover:border-emerald-500 transition-all mx-auto">` : `-`}</td><td class="p-4 text-center"><button onclick="toggleTeacherStatus('${t.email}', '${statusClean}')" class="text-[10px] px-4 py-2 rounded-full font-black uppercase shadow-sm border transition-all ${statusClean === 'Aktif' ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/50 hover:bg-emerald-500/40' : 'bg-amber-500/20 text-amber-400 border-amber-500/50 hover:bg-amber-500/40'}">${statusClean}</button></td></tr>`;
                    }).join('');
                } else { body.innerHTML = `<tr><td colspan="5" class="p-10 text-center italic text-slate-500">Belum ada sekolah terdaftar.</td></tr>`; }
            } catch (e) {}
        }

        window.toggleTeacherStatus = async (email, currentStatus) => {
            const nextStatus = currentStatus === 'Aktif' ? 'Menunggu' : 'Aktif';
            showToast(`Mengubah status ke ${nextStatus}...`);
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'setTeacherStatus', email: email, status: nextStatus }) });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast("Status Berhasil Diubah!");
                    fetchTeachersList();
                    updatePendingBadges();
                }
            } catch (e) { showToast("Gagal mengubah status.", false); }
        };

        window.viewProof = (url, school) => {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/90 z-[700] flex flex-col items-center justify-center p-6 backdrop-blur-sm';
            overlay.innerHTML = `
                <div class="w-full max-w-2xl relative">
                    <div class="flex justify-between items-center mb-4 text-white">
                        <h3 class="font-black uppercase tracking-widest text-emerald-400">Bukti Transfer: ${school}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center font-bold hover:bg-rose-600 transition-all">‚úï</button>
                    </div>
                    <img src="${url}" class="w-full h-auto rounded-3xl shadow-2xl border-4 border-white/10 object-contain max-h-[70vh]">
                    <a href="${url}" download="Bukti_${school}.png" class="mt-6 block w-full py-4 bg-emerald-600 text-white text-center rounded-2xl font-black uppercase tracking-widest shadow-lg">Download File</a>
                </div>`;
            document.body.appendChild(overlay);
        };

        window.saveMasterSettings = async () => {
            const btn = document.getElementById('saveGlobalBtn');
            const originalText = btn.textContent;
            btn.disabled = true; btn.innerHTML = `<div class="flex items-center justify-center gap-3"><div class="loader"></div><span>MENYIMPAN...</span></div>`;
            const newConf = { app_title: document.getElementById('m_title').value, bank_name: document.getElementById('m_bank').value, bank_account: document.getElementById('m_rek').value, registration_fee: document.getElementById('m_fee').value, master_password: document.getElementById('m_pass').value };
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'setGlobalSettings', config: newConf }) });
                const data = await res.json();
                if (data.status === 'success') { window.elementSdk.setConfig(newConf); showToast("Konfigurasi Berhasil Diperbarui!"); }
            } catch (e) { showToast("Gagal.", false); } finally { btn.disabled = false; btn.textContent = originalText; }
        };

        // --- LANDING & REGISTRATION ---
        async function renderLanding() {
            showSkeleton();
            await fetchGlobalSettings();
            const config = window.elementSdk.config;
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-emerald-600 flex flex-col items-center justify-center p-6 relative overflow-hidden text-center">
                    <div class="absolute top-0 left-0 w-64 h-64 bg-emerald-50 rounded-full -ml-32 -mt-32 opacity-50"></div>
                    <div id="mainBox" class="glass p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md relative z-10 text-slate-800">
                        <div id="step-1">
                            <h1 class="text-4xl font-black text-center mb-8 tracking-tight leading-none uppercase text-slate-800">Daftar Sekolah</h1>
                            <form id="regForm" class="space-y-4 text-left">
                                <div><label class="block text-[10px] font-bold text-slate-400 uppercase px-2 mb-1 tracking-widest text-left">Gmail Guru</label><input type="email" id="regEmail" placeholder="Gmail Guru" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl outline-none font-bold focus:border-emerald-500 transition-all text-slate-800" required></div>
                                <div><label class="block text-[10px] font-bold text-slate-400 uppercase px-2 mb-1 tracking-widest text-left">Nama Sekolah</label><input type="text" id="regSchool" placeholder="Nama Sekolah" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl outline-none font-bold focus:border-emerald-500 transition-all text-slate-800" required></div>
                                <button type="submit" id="btnNextStep" class="w-full bg-emerald-600 text-white p-5 rounded-2xl font-black shadow-xl hover:scale-[1.02] transition-all uppercase tracking-widest">Lanjut ke Pembayaran</button>
                            </form>
                            <!-- BERUBAH: Baris Login Master telah dihapus/disembunyikan dari sini -->
                        </div>
                        <div id="step-2" class="hidden space-y-6">
                            <div id="dynamicPayment"></div>
                            <div class="space-y-2 text-left">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase px-2 tracking-widest text-left">Unggah Bukti Transfer</label>
                                <div class="relative group">
                                    <input type="file" id="proofImg" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                                    <div id="fileBox" class="w-full p-5 bg-white border-2 border-slate-100 border-dashed rounded-3xl flex flex-col items-center justify-center gap-3 group-hover:border-emerald-500 transition-all relative overflow-hidden">
                                        <div id="previewContainer" class="hidden w-full aspect-video rounded-2xl overflow-hidden mb-1 shadow-inner bg-slate-50 border border-slate-100"><img id="uploadPreview" class="w-full h-full object-contain"></div>
                                        <div id="uploadPrompt" class="flex flex-col items-center gap-2"><div class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600 text-xl font-bold">üì∏</div><span id="fileName" class="text-[10px] font-black uppercase text-slate-400 text-center leading-tight">Pilih Foto Bukti</span></div>
                                    </div>
                                </div>
                            </div>
                            <button id="confirmBtn" class="w-full bg-slate-900 text-white p-5 rounded-[1.5rem] font-black shadow-lg hover:scale-[1.02] transition-all uppercase tracking-widest">Kirim Konfirmasi</button>
                            <button onclick="location.reload()" class="w-full text-slate-300 text-[10px] font-bold uppercase py-2">Kembali</button>
                        </div>
                        <div id="step-3" class="hidden space-y-6 text-center">
                            <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-inner">‚úÖ</div>
                            <h2 class="text-2xl font-black text-slate-800 leading-tight uppercase">Status: LUNAS</h2>
                            <p class="text-sm text-slate-500 font-medium mb-8">Pendaftaran sukses. Menunggu verifikasi admin.</p>
                            <div class="bg-slate-900 p-6 rounded-[2rem] text-left">
                                <p class="text-[10px] font-bold text-emerald-400 uppercase mb-2 tracking-widest">Link Akses:</p>
                                <textarea id="shareLink" class="w-full p-3 bg-slate-800 text-white border-none rounded-xl text-[10px] font-mono h-16 mb-4 outline-none resize-none" readonly></textarea>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="window.copyLink()" class="py-4 bg-emerald-600 text-white rounded-xl font-bold text-xs shadow-lg uppercase tracking-wider animate-pulse-custom">Salin Link</button>
                                    <button onclick="window.downloadLink()" class="py-4 bg-blue-600 text-white rounded-xl font-bold text-xs shadow-lg uppercase tracking-wider animate-pulse-custom">Download Link</button>
                                </div>
                                <button onclick="location.reload()" class="w-full mt-4 py-4 bg-slate-700 text-white rounded-xl font-bold text-xs shadow-lg uppercase tracking-wider">Ke Beranda</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            const fileInput = document.getElementById('proofImg');
            if(fileInput) { fileInput.onchange = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (event) => { document.getElementById('uploadPreview').src = event.target.result; document.getElementById('previewContainer').classList.remove('hidden'); document.getElementById('uploadPrompt').classList.add('opacity-50'); document.getElementById('fileName').textContent = file.name; document.getElementById('fileBox').classList.add('bg-emerald-50', 'border-emerald-500'); }; reader.readAsDataURL(file); } }; }
            
            document.getElementById('regForm').onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btnNextStep');
                btn.disabled = true; btn.innerHTML = `<div class="flex items-center justify-center gap-3"><div class="loader"></div><span>MEMPROSES...</span></div>`;
                try {
                    const latestConfig = await fetchGlobalSettings();
                    const accParts = latestConfig.bank_account.split(' a/n ');
                    document.getElementById('dynamicPayment').innerHTML = `
                        <div class="mb-6 text-center"><div class="bg-emerald-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto text-3xl mb-4 shadow-inner">üè¶</div><h2 class="text-2xl font-black text-slate-800 leading-tight uppercase tracking-tight">TAGIHAN</h2></div>
                        <div class="bg-emerald-50 p-6 rounded-[2rem] border-2 border-dashed border-emerald-200 text-left mb-4">
                            <p class="text-3xl font-black text-emerald-600 uppercase mb-1 tracking-widest">${latestConfig.bank_name}</p>
                            <p class="text-2xl font-black text-emerald-700 tracking-tighter mt-1">${accParts[0] || '1234567890'}</p>
                            ${accParts[1] ? `<p class="text-sm font-bold text-slate-600">a/n ${accParts[1]}</p>` : ''}
                            <div class="mt-4 pt-4 border-t border-emerald-200"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Biaya Aktivasi:</p><p class="text-3xl font-black text-slate-800">${formatRupiah(latestConfig.registration_fee)}</p></div>
                        </div>`;
                    document.getElementById('step-1').classList.add('hidden');
                    document.getElementById('step-2').classList.remove('hidden');
                } catch (err) { showToast("Gagal.", false); btn.disabled = false; btn.innerHTML = "Lanjut"; }
            };
            
            document.getElementById('confirmBtn').onclick = async () => {
                const file = document.getElementById('proofImg').files[0];
                if(!file) return showToast("Pilih bukti!", false);
                const btn = document.getElementById('confirmBtn');
                btn.disabled = true; btn.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="loader"></div><span>MENGIRIM...</span></div>`;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64Img = event.target.result;
                    try {
                        const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'registerTeacher', email: document.getElementById('regEmail').value, nama_sekolah: document.getElementById('regSchool').value, proof: base64Img }) });
                        const data = await res.json();
                        if (data.status === 'success' || data.ss_id) {
                            document.getElementById('step-2').classList.add('hidden');
                            document.getElementById('step-3').classList.remove('hidden');
                            const appLink = window.location.href.split('?')[0] + '?id=' + (data.ss_id || 'ID_PENDING');
                            document.getElementById('shareLink').value = appLink;
                            showToast("Pendaftaran sukses!");
                        }
                    } catch(err) { btn.disabled = false; btn.textContent = "Kirim"; showToast("Gagal.", false); }
                };
                reader.readAsDataURL(file);
            };
        }

        window.checkAdminAccess = () => {
            const pass = prompt("Masukkan Password Master:");
            if(pass === window.elementSdk.config.master_password) { renderMasterAdmin(); }
            else if(pass !== null) { showToast("Password Salah!", false); }
        };

        window.copyLink = () => { const el = document.getElementById('shareLink'); el.select(); document.execCommand('copy'); showToast("‚úÖ Link Berhasil Disalin!"); };
        window.downloadLink = () => { const linkOnly = document.getElementById('shareLink').value; const fullText = `${linkOnly}\n\nPetunjuk Guru:\nMasuk menggunakan tanda bintang (*).\nNama Lengkap Siswa: *\nKlik masuk sekarang.`; const blob = new Blob([fullText], { type: 'text/plain' }); const anchor = document.createElement('a'); anchor.download = 'Link_Akses_Ramadhan.txt'; anchor.href = URL.createObjectURL(blob); anchor.click(); showToast("üì• Berhasil Diunduh!"); };

        // --- LOGIN SISWA ---
        async function showLoginPage() {
            showSkeleton();
            await fetchGlobalSettings();
            const config = window.elementSdk.config;
            let opts = `<option value="">Pilih Kelas</option>`;
            ['4','5','6'].forEach(k => { 
                opts += `<option value="${k}">Kelas ${k}</option>`; 
            });
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-emerald-600 flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl p-8 animate-in fade-in zoom-in duration-500 text-center text-slate-800">
                        <h1 class="text-3xl font-black text-emerald-800 mb-2 uppercase tracking-tight">${config.app_title}</h1>
                        <p class="text-xs text-gray-400 mb-8 uppercase tracking-widest font-bold">${schoolName}</p>
                        <form id="loginForm" class="space-y-4 text-left">
                            <div><label class="block mb-1 font-bold text-[10px] uppercase text-gray-400 px-2 tracking-widest text-left">Nama Lengkap Siswa</label><input type="text" id="nama" class="w-full px-5 py-4 bg-slate-50 border-2 border-transparent rounded-2xl outline-none focus:border-emerald-500 transition-all uppercase font-bold text-slate-800" placeholder="Ketik Nama Anda"></div>
                            <div><label class="block mb-1 font-bold text-[10px] uppercase text-gray-400 px-2 tracking-widest text-left">Kelas</label><select id="kelas" class="w-full px-5 py-4 bg-slate-50 border-2 border-transparent rounded-2xl bg-white outline-none focus:border-emerald-500 transition-all font-bold uppercase text-slate-800">${opts}</select></div>
                            <button id="loginBtn" type="submit" class="w-full bg-emerald-600 text-white py-5 rounded-[1.5rem] font-black shadow-xl transition-all uppercase tracking-widest mt-4">Masuk Sekarang</button>
                        </form>
                        <p class="mt-8 text-[9px] text-gray-300 font-bold uppercase tracking-[0.2em]">Multi-School Portal &copy; 2026</p>
                    </div>
                </div>`;
            document.getElementById('loginForm').onsubmit = async (e) => {
                e.preventDefault();
                const n = document.getElementById('nama').value.trim();
                const k = document.getElementById('kelas').value;
                const btn = document.getElementById('loginBtn');
                
                if (n === '*') { 
                    currentUser = { nama_lengkap: '*', kelas: '*', role: 'guru' }; 
                    showPanelGuruPage(); 
                    return; 
                }

                if(!n || !k) return showToast("Mohon isi Nama dan Kelas!", false); 
                
                const originalBtnHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="loader"></div><span>Menghubungkan...</span></div>`;
                try {
                    currentUser = { nama_lengkap: n, kelas: k, role: 'siswa' }; 
                    await syncUserFromCloud(); 
                    showAmalanPage(); 
                } catch (err) {
                    showToast("Koneksi gagal.", false);
                    showAmalanPage();
                } finally {
                    if(document.getElementById('loginBtn')) { btn.disabled = false; btn.innerHTML = originalBtnHtml; }
                }
            };
        }

        async function syncUserFromCloud() {
            if (!currentUser || currentUser.role === 'guru') return false;
            try {
                const url = new URL(GOOGLE_SCRIPT_URL);
                url.searchParams.append('action', 'read');
                url.searchParams.append('ss_id', SCHOOL_ID);
                url.searchParams.append('nama', currentUser.nama_lengkap);
                url.searchParams.append('kelas', currentUser.kelas);
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success' && Array.isArray(result.data)) {
                    cloudRecords = result.data;
                    result.data.forEach(item => {
                        const tgl = parseInt(item.tanggal);
                        if(isNaN(tgl)) return;
                        const cat = item.kategori;
                        let detail = parseRecordData(item.detail);
                        if (cat === 'Shalat Fardu') shalatData[tgl] = { ...shalatData[tgl], ...(typeof detail === 'object' ? detail : {}) };
                        else if (cat === 'Tarawih') tarawihData[tgl] = { ...tarawihData[tgl], ...(typeof detail === 'object' ? detail : {}) };
                        else if (cat === 'Puasa') puasaData[tgl] = detail;
                        else if (cat === 'Tadarus') tadarusData[tgl] = { ...tadarusData[tgl], ...(typeof detail === 'object' ? detail : {}) };
                        else if (cat === 'Ceramah') ceramahData[tgl] = { ...ceramahData[tgl], ...(typeof detail === 'object' ? detail : {}) };
                    });
                    return true;
                }
                return false;
            } catch (e) { return false; }
        }

        function showAmalanPage() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-emerald-600 p-4 text-slate-800 text-center">
                    <div class="max-w-4xl mx-auto pb-24 text-center">
                        <div class="bg-white rounded-[2rem] shadow-xl p-8 mb-6 relative overflow-hidden text-center">
                            <h1 class="text-2xl font-black uppercase tracking-tight text-center">Amalan Ramadhan</h1>
                            <div class="mt-4 flex flex-col md:flex-row justify-between items-center bg-slate-50 p-6 rounded-3xl gap-4 border border-slate-100">
                                <div class="text-center md:text-left"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-left">Siswa Aktif</p><p class="text-lg font-black text-slate-800 uppercase leading-none mt-1">${currentUser.nama_lengkap} (${currentUser.kelas})</p></div>
                                <div class="flex gap-2">
                                    <button id="rekapBtn" class="px-5 py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs shadow-lg uppercase tracking-wider">Rekap</button>
                                    <button onclick="location.reload()" class="px-5 py-3 bg-rose-500 text-white rounded-xl font-bold text-xs shadow-lg uppercase tracking-wider">Keluar</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-[1.5rem] shadow-lg mb-6 overflow-hidden flex sticky top-2 z-50 border-4 border-white overflow-x-auto no-scrollbar">
                            ${categories.map(cat => `<button class="tab-button flex-1 py-4 px-4 font-black text-[10px] uppercase whitespace-nowrap tracking-widest transition-all ${currentTab === cat ? 'active' : 'bg-slate-50 text-slate-400'}">${cat.split(' ')[0]}</button>`).join('')}
                        </div>
                        <div id="contentArea" class="bg-white rounded-[2rem] shadow-xl p-8 min-h-[400px]"></div>
                    </div>
                </div>`;
            document.getElementById('rekapBtn').onclick = async () => { await syncUserFromCloud(); showRekapPage(); };
            document.querySelectorAll('.tab-button').forEach((btn, idx) => { btn.onclick = () => { currentTab = categories[idx]; showAmalanPage(); }; });
            renderContentArea();
        }

        function renderContentArea() {
            const area = document.getElementById('contentArea');
            const days = Array.from({length: 30}, (_, i) => i + 1);
            if (currentTab === 'Shalat Fardu') {
                area.innerHTML = `<div class="space-y-8">${days.map(t => `
                    <div class="p-6 border rounded-2xl bg-white shadow-sm border-l-8 border-emerald-500 text-center">
                        <h3 class="font-black text-emerald-800 mb-4 text-sm text-center uppercase">üìÖ HARI KE-${t}</h3>
                        <div class="space-y-4 text-left">
                            ${['Subuh','Dzuhur','Ashar','Maghrib','Isya'].map(w => `
                                <div class="flex flex-col md:flex-row md:items-center gap-3 pb-3 border-b border-gray-50 last:border-0 text-left">
                                    <div class="w-24 font-bold text-gray-600 text-xs text-left">‚è∞ ${w}</div>
                                    <div class="flex flex-wrap gap-1 flex-1">
                                        ${['berjamaah','munfarid','haid','tidak shalat'].map(s => `<button class="px-2 py-1.5 text-[9px] rounded-full border transition-all font-bold uppercase ${shalatData[t]?.[w] === s ? 'bg-emerald-600 text-white' : 'bg-white text-gray-400 border-gray-100'}" onclick="shalatData[${t}]['${w}']='${s}'; renderContentArea();">${s}</button>`).join('')}
                                    </div>
                                    <button class="px-3 py-1.5 text-[9px] rounded-lg bg-blue-600 text-white font-bold" onclick="handleSimpanAmalan(${t}, 'Shalat Fardu', shalatData[${t}], '${w}')">SIMPAN</button>
                                </div>`).join('')}
                        </div>
                    </div>`).join('')}</div>`;
            } else if (currentTab === 'Tarawih') {
                area.innerHTML = `<div class="space-y-6">${days.map(t => `<div class="p-6 border rounded-2xl border-l-8 border-indigo-500 text-center"><h3 class="font-black text-indigo-900 mb-4 text-sm text-center uppercase">üìÖ HARI KE-${t}</h3><div class="flex flex-wrap gap-2 justify-center mb-4">${['berjamaah','munfarid','tidak mengerjakan','sakit','haid'].map(s => `<button class="px-3 py-2 text-[10px] border rounded-xl font-bold uppercase ${tarawihData[t]?.status === s ? 'bg-indigo-600 text-white' : 'bg-white text-gray-400'}" onclick="tarawihData[${t}].status='${s}'; renderContentArea();">${s}</button>`).join('')}</div><div class="flex gap-2 justify-center mb-4">${['mesjid','rumah'].map(tmp => `<button class="px-4 py-2 text-[10px] border rounded-xl font-bold uppercase ${tarawihData[t]?.tempat === tmp ? 'bg-indigo-600 text-white' : 'bg-white text-gray-400'}" onclick="tarawihData[${t}].tempat='${tmp}'; renderContentArea();">${tmp}</button>`).join('')}</div><button class="w-full py-3 bg-indigo-600 text-white rounded-xl font-black text-xs uppercase shadow-md" onclick="handleSimpanAmalan(${t}, 'Tarawih', tarawihData[${t}])">SIMPAN TARAWIH</button></div>`).join('')}</div>`;
            } else if (currentTab === 'Puasa') {
                area.innerHTML = `<div class="space-y-4">${days.map(t => `<div class="p-6 border rounded-2xl border-l-8 border-orange-500 text-center"><h3 class="font-black text-orange-900 mb-4 text-sm text-center uppercase">üìÖ HARI KE-${t}</h3><div class="flex flex-wrap gap-2 justify-center mb-4">${['mengerjakan','tidak mengerjakan','sakit','haid'].map(s => `<button class="px-4 py-2 text-[10px] border rounded-xl font-bold uppercase ${puasaData[t] === s ? 'bg-orange-500 text-white' : 'bg-white text-gray-400'}" onclick="puasaData[${t}]='${s}'; renderContentArea();">${s}</button>`).join('')}</div><button class="w-full py-3 bg-orange-500 text-white rounded-xl font-black text-xs uppercase shadow-md" onclick="handleSimpanAmalan(${t}, 'Puasa', puasaData[${t}])">SIMPAN PUASA</button></div>`).join('')}</div>`;
            } else if (currentTab === 'Tadarus') {
                area.innerHTML = `<div class="space-y-6">${days.map(t => `<div class="p-6 border rounded-2xl border-l-8 border-blue-500 text-left text-slate-800 text-center"><h3 class="font-black text-blue-900 mb-4 text-sm text-center uppercase">üìÖ HARI KE-${t}</h3><div class="flex gap-2 justify-center mb-4">${['sendiri','ustadz'].map(m => `<button class="px-4 py-2 text-[10px] border rounded-xl font-bold uppercase ${tadarusData[t]?.pilihan === m ? 'bg-blue-600 text-white' : 'bg-white text-gray-400'}" onclick="tadarusData[${t}].pilihan='${m}'; renderContentArea();">${m === 'sendiri' ? 'Mandiri' : 'Bersama Ustadz'}</button>`).join('')}</div><div class="grid grid-cols-2 gap-3 mb-4"><input type="text" class="p-3 border rounded-xl text-xs outline-none focus:border-blue-500 font-bold text-slate-800" placeholder="Nama Surat" value="${tadarusData[t]?.surat || ''}" oninput="tadarusData[${t}].surat=this.value"><input type="text" class="p-3 border rounded-xl text-xs outline-none focus:border-blue-500 font-bold text-slate-800" placeholder="Ayat" value="${tadarusData[t]?.ayat || ''}" oninput="tadarusData[${t}].ayat=this.value"></div><button class="w-full py-3 bg-blue-600 text-white rounded-xl font-black text-xs uppercase shadow-md" onclick="handleSimpanAmalan(${t}, 'Tadarus', tadarusData[${t}])">SIMPAN TADARUS</button></div>`).join('')}</div>`;
            } else if (currentTab === 'Ceramah') {
                area.innerHTML = `<div class="space-y-6">${days.map(t => `<div class="p-6 border rounded-2xl border-l-8 border-rose-500 text-left text-slate-800 text-center"><h3 class="font-black text-rose-900 mb-4 text-sm text-center uppercase">üìÖ HARI KE-${t}</h3><div class="space-y-3"><input type="text" class="w-full p-3 border rounded-xl text-xs outline-none focus:border-rose-500 font-bold text-slate-800" placeholder="Nama Penceramah" value="${ceramahData[t]?.penceramah || ''}" oninput="ceramahData[${t}].penceramah=this.value"><input type="text" class="w-full p-3 border rounded-xl text-xs outline-none focus:border-rose-500 font-bold text-slate-800" placeholder="Tempat / Media" value="${ceramahData[t]?.tempat || ''}" oninput="ceramahData[${t}].tempat=this.value"><textarea class="w-full p-3 border rounded-xl text-xs outline-none focus:border-rose-500 h-20 font-bold text-slate-800" placeholder="Ringkasan isi ceramah..." oninput="ceramahData[${t}].ringkasan=this.value">${ceramahData[t]?.ringkasan || ''}</textarea></div><button class="w-full py-3 mt-4 bg-rose-600 text-white rounded-xl font-black text-xs uppercase shadow-md" onclick="handleSimpanAmalan(${t}, 'Ceramah', ceramahData[${t}])">SIMPAN CERAMAH</button></div>`).join('')}</div>`;
            }
        }

        async function handleSimpanAmalan(tgl, kategori, detailObj, specificTime = null) {
            if (kategori === 'Shalat Fardu') { if (specificTime && !detailObj[specificTime]) { showToast(`Pilih status!`, false); return; } }
            else if (kategori === 'Tarawih') { if (!detailObj.status || !detailObj.tempat) { showToast("Lengkapi data!", false); return; } }
            else if (kategori === 'Puasa') { if (!detailObj) { showToast("Pilih status!", false); return; } }
            else if (kategori === 'Tadarus') { if (!detailObj.pilihan || !detailObj.surat.trim() || !detailObj.ayat.trim()) { showToast("Lengkapi data!", false); return; } }
            else if (kategori === 'Ceramah') { if (!detailObj.penceramah.trim() || !detailObj.tempat.trim() || !detailObj.ringkasan.trim()) { showToast("Lengkapi data!", false); return; } }
            showToast(`Menyimpan...`);
            try {
                const payload = { ss_id: SCHOOL_ID, nama: currentUser.nama_lengkap, kelas: currentUser.kelas, kategori: kategori, tanggal: tgl, detail: typeof detailObj === 'object' ? JSON.stringify(detailObj) : detailObj };
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                showToast(`Berhasil!`);
            } catch(e) { showToast("Gagal.", false); }
        }

        async function showRekapPage() {
            const data = getMergedRecords(cloudRecords);
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-slate-50 p-4 md:p-8 text-slate-800 text-center">
                    <div class="max-w-4xl mx-auto text-center">
                        <div class="bg-white p-6 rounded-2xl shadow-xl mb-6 flex justify-between items-center text-center">
                            <h2 class="font-black text-xl text-emerald-800 uppercase text-center">üìä Rekap Amalan Saya</h2>
                            <button onclick="showAmalanPage()" class="px-4 py-2 bg-slate-800 text-white rounded-lg font-bold text-xs text-center uppercase">KEMBALI</button>
                        </div>
                        <div class="space-y-6 text-center">
                            ${categories.map(cat => {
                                const items = data.filter(r => r.kategori === cat).sort((a,b) => parseInt(a.tanggal) - parseInt(b.tanggal));
                                return `<div class="bg-white rounded-2xl shadow-md overflow-hidden border text-left text-center"><div class="p-4 bg-emerald-50 border-b flex justify-between items-center"><span class="font-black text-emerald-800 uppercase">${getCategoryIcon(cat)} ${cat}</span><span class="text-[10px] font-bold text-emerald-600 bg-white px-2 py-1 rounded-full border uppercase">${items.length} Data</span></div><div class="p-4 space-y-2 text-left">${items.length > 0 ? items.map(r => `<div class="text-xs p-2 border-b last:border-0"><b>Hari ${r.tanggal}:</b> ${renderDetailText(cat, r.detail)}</div>`).join('') : '<p class="text-xs text-gray-300 italic p-2 text-center">Belum ada data.</p>'}</div></div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
        }

        async function showPanelGuruPage() {
            showToast("Memuat Database...");
            try {
                const url = new URL(GOOGLE_SCRIPT_URL);
                url.searchParams.append('action', 'readAll');
                url.searchParams.append('ss_id', SCHOOL_ID);
                const res = await fetch(url);
                const result = await res.json();
                if(result.status === 'success') { allRecords = result.data; renderLaporanPanel(allRecords); }
            } catch(e) { showToast("Gagal.", false); }
        }

        function renderLaporanPanel(dataRaw) {
            const data = getMergedRecords(dataRaw);
            const studentList = [...new Set(data.map(r => JSON.stringify({nama: r.nama, kelas: r.kelas})))].map(s => JSON.parse(s)).sort((a,b) => a.nama.localeCompare(b.nama));
            const classList = [...new Set(data.map(r => r.kelas))].sort();
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-slate-100 p-4 md:p-6 text-slate-800 text-center">
                    <div class="max-w-6xl mx-auto text-center">
                        <div class="bg-white p-8 rounded-2xl shadow-xl mb-6 flex flex-col md:flex-row justify-between items-center gap-4 border-b-4 border-emerald-500 text-center">
                            <div><h1 class="text-3xl font-black uppercase tracking-tight leading-none text-slate-800">Panel Rekap Guru</h1><p class="text-xs text-slate-400 font-bold mt-1 text-left uppercase">Penyajian Data Sekolah</p></div>
                            <div class="flex flex-wrap gap-2">
                                <button id="cetakGlobalBtn" class="px-5 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg uppercase text-xs tracking-wider">üñ®Ô∏è Cetak Laporan</button>
                                <button onclick="location.reload()" class="px-5 py-3 bg-slate-900 text-white rounded-xl font-bold shadow-lg uppercase text-xs tracking-wider">Keluar</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-md mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="block text-[10px] font-black text-gray-400 mb-1 uppercase text-left tracking-widest">Tingkatan</label><select id="fTingkat" class="w-full p-2 border-2 rounded-xl outline-none focus:border-emerald-500 font-bold text-left"><option value="all">Semua</option><option value="4">Kelas 4</option><option value="5">Kelas 5</option><option value="6">Kelas 6</option></select></div>
                                <div><label class="block text-[10px] font-black text-gray-400 mb-1 uppercase text-left tracking-widest">Kelas</label><select id="fKelas" class="w-full p-2 border-2 rounded-xl outline-none focus:border-emerald-500 font-bold text-left"><option value="all">Semua</option>${classList.map(k => `<option value="${k}">${k}</option>`).join('')}</select></div>
                                <div><label class="block text-[10px] font-black text-gray-400 mb-1 uppercase text-left tracking-widest">Cari Nama</label><input type="text" id="fNama" class="w-full p-2 border-2 rounded-xl outline-none focus:border-emerald-500 font-bold text-left" placeholder="Ketik nama..."></div>
                            </div>
                        </div>
                        <div id="studentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>`;
            const grid = document.getElementById('studentGrid');
            const filterData = () => {
                const ting = document.getElementById('fTingkat').value;
                const kel = document.getElementById('fKelas').value;
                const nam = document.getElementById('fNama').value.toLowerCase();
                const filtered = studentList.filter(s => {
                    const m1 = ting === 'all' || s.kelas.toString().startsWith(ting);
                    const m2 = kel === 'all' || s.kelas === kel;
                    const m3 = s.nama.toLowerCase().includes(nam);
                    return m1 && m2 && m3;
                });
                if (filtered.length === 0) { grid.innerHTML = `<div class="col-span-full p-12 bg-white rounded-2xl text-center text-gray-400 italic">Siswa tidak ditemukan.</div>`; return; }
                grid.innerHTML = filtered.map(s => `<div class="bg-white p-5 rounded-2xl shadow-sm border hover:border-emerald-500 cursor-pointer transition-all student-card" data-n="${s.nama}" data-k="${s.kelas}"><div class="flex justify-between items-start"><div><h3 class="font-black text-gray-800 uppercase text-left">${s.nama}</h3><p class="text-xs font-bold text-emerald-600 mt-1 uppercase text-left">Kelas: ${s.kelas}</p></div><span class="text-[10px] bg-emerald-50 text-emerald-700 px-2 py-1 rounded-lg font-bold border border-emerald-100 uppercase">Detail</span></div></div>`).join('');
                
                grid.querySelectorAll('.student-card').forEach(c => {
                    c.onclick = () => showStudentDetailView({ nama: c.dataset.n.trim(), kelas: c.dataset.k.trim() }, data);
                });
            };
            document.getElementById('fTingkat').onchange = filterData;
            document.getElementById('fKelas').onchange = filterData;
            document.getElementById('fNama').oninput = filterData;
            document.getElementById('cetakGlobalBtn').onclick = () => handleCetakGlobal(document.getElementById('fTingkat').value, document.getElementById('fKelas').value, data);
            filterData();
        }

        function showStudentDetailView(student, allData) {
            const studentRecords = allData.filter(r => 
                r.nama.toString().trim() == student.nama && 
                r.kelas.toString().trim() == student.kelas
            );

            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-slate-50 p-6 text-slate-800 text-center">
                    <div class="max-w-4xl mx-auto text-center">
                        <div class="bg-white p-6 rounded-2xl shadow-xl mb-6 flex flex-col md:flex-row justify-between items-center gap-4 text-center">
                            <div class="text-left"><h2 class="font-black text-2xl text-slate-800 uppercase text-left">${student.nama}</h2><p class="font-bold text-emerald-600 uppercase text-left">Kelas: ${student.kelas}</p></div>
                            <div class="flex gap-2"><button id="cetakIndv" class="px-5 py-2 bg-emerald-600 text-white rounded-xl font-bold shadow-md uppercase text-xs tracking-wider">üñ®Ô∏è Cetak</button><button id="backAdmin" class="px-5 py-2 bg-slate-800 text-white rounded-xl font-bold shadow-md uppercase text-xs tracking-wider">‚Üê Kembali</button></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                            ${categories.map(cat => {
                                const items = studentRecords.filter(r => r.kategori === cat).sort((a,b) => parseInt(a.tanggal) - parseInt(b.tanggal));
                                return `<div class="bg-white p-6 rounded-2xl shadow-sm border text-left text-center"><h3 class="font-black border-b pb-2 mb-4 text-slate-700 uppercase text-left">${getCategoryIcon(cat)} ${cat}</h3><div class="space-y-2 text-left">${items.length ? items.map(r => `<div class="text-[10px] p-3 bg-slate-50 rounded-lg border border-slate-100 uppercase"><b>HARI ${r.tanggal}:</b><br>${renderDetailText(cat, r.detail)}</div>`).join('') : '<p class="text-xs text-gray-300 text-center italic">Belum ada data.</p>'}</div></div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
            document.getElementById('backAdmin').onclick = () => renderLaporanPanel(allRecords);
            document.getElementById('cetakIndv').onclick = () => handleCetakIndividu(student, studentRecords);
        }

        function handleCetakGlobal(ting, kel, allData) {
            const printWindow = window.open('', '_blank');
            let students = [...new Set(allData.map(r => JSON.stringify({nama: r.nama, kelas: r.kelas})))].map(s => JSON.parse(s));
            if(ting !== 'all') students = students.filter(s => s.kelas.toString().startsWith(ting));
            if(kel !== 'all') students = students.filter(s => s.kelas === kel);
            students.sort((a,b) => a.nama.localeCompare(b.nama));
            let html = `<html><head><title>Laporan Global</title><style>body{font-family:Arial;padding:30px;font-size:12px}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid #000;padding:8px;text-align:center}.header{text-align:center;margin-bottom:30px}</style></head><body><div class="header"><h2>REKAPITULASI AMALAN RAMADHAN SISWA</h2><div>Tingkat: ${ting} | Kelas: ${kel}</div></div><table><thead><tr><th>No</th><th>Nama Siswa</th><th>Kelas</th><th>Total Data</th><th>Status</th></tr></thead><tbody>`;
            students.forEach((s, idx) => { const count = allData.filter(r => r.nama === s.nama && r.kelas === s.kelas).length; html += `<tr><td>${idx+1}</td><td>${s.nama.toUpperCase()}</td><td>${s.kelas}</td><td>${count}</td><td>AKTIF</td></tr>`; });
            html += `</tbody></table><div style="margin-top:50px;text-align:right">Dicetak pada: ${new Date().toLocaleDateString('id-ID')}<br><br><br><br>( ............................... )</div><script>window.print();<\/script></body></html>`;
            printWindow.document.write(html); printWindow.document.close();
        }

        function handleCetakIndividu(student, data) {
            const printWindow = window.open('', '_blank');
            let html = `<html><head><title>Laporan Individual</title><style>body{font-family:Arial;padding:40px;font-size:12px}.header{text-align:center;border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:20px}table{width:100%;border-collapse:collapse;margin-bottom:20px}th,td{border:1px solid #000;padding:6px;text-align:left}</style></head><body><div class="header"><h2>LAPORAN AMALAN RAMADHAN SISWA</h2><div>TAHUN PELAJARAN 2025/2026</div></div><p><b>NAMA:</b> ${student.nama.toUpperCase()}<br><b>KELAS:</b> ${student.kelas}</p>`;
            categories.forEach(cat => {
                const items = data.filter(r => r.kategori === cat).sort((a,b) => parseInt(a.tanggal) - parseInt(b.tanggal));
                if(items.length > 0) { html += `<h3>${cat}</h3><table><thead><tr><th width="60" align="center">Hari</th><th>Detail Amalan</th></tr></thead><tbody>`; items.forEach(r => html += `<tr><td align="center">${r.tanggal}</td><td>${renderDetailText(cat, r.detail)}</td></tr>`); html += `</tbody></table>`; }
            });
            html += `<div style="margin-top:50px;text-align:right">Dicetak pada: ${new Date().toLocaleDateString('id-ID')}<br><br><br><br>( ............................... )</div><script>window.print();<\/script></body></html>`;
            printWindow.document.write(html); printWindow.document.close();
        }

        async function init() { 
            if (!SCHOOL_ID) {
                renderLanding(); 
            } else {
                await fetchCurrentSchoolName();
                showLoginPage(); 
            }
        }
        init();
  </script>
 </body>
</html>
